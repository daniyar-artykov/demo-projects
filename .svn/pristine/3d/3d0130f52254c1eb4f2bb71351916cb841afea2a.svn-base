package sleekbill.beans;

import java.io.File;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.Callable;

import sleekbill.Common;
import sleekbill.Config;
import sleekbill.db.SBConnection;
import sleekbill.entities.CompanyDetailsEntity;
import sleekbill.entities.EstimateEntity;
import sleekbill.entities.EstimateProductEntity;
import sleekbill.entities.StateEntity;
import sleekbill.entities.TaxEntity;
import sleekbill.jasper.Document;

import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.dao.DaoManager;
import com.j256.ormlite.dao.GenericRawResults;
import com.j256.ormlite.dao.RawRowMapper;
import com.j256.ormlite.jdbc.JdbcConnectionSource;
import com.j256.ormlite.misc.TransactionManager;
import com.j256.ormlite.stmt.PreparedQuery;
import com.j256.ormlite.stmt.SelectArg;
import com.j256.ormlite.stmt.UpdateBuilder;
import java.text.NumberFormat;
import java.util.logging.Level;
import java.util.logging.Logger;
import sleekbill.frames.JDialogIssueInvoice;
import sleekbill.utils.SBStringUtils;

public class Estimate extends EstimateEntity implements Document {

    public static final String TYPE_QUOTATION = "q";
    public static final String TYPE_PROFORMA = "p";
    public static final String TYPE_DELIVERY = "c"; // c from challan

    public static final String DOCUMENT_TYPE_NAME = "quotation";
    static final String[] columnNames = new String[]{"NO", "PRODUCT", "DESCRIPTION", "UM", "QUANTITY", "PRICE", "DISCOUNT", "VALUE", "AMOUNT", "TAX_AMOUNT", "TAX_NAME", "BREAK"};
    private Dao<EstimateEntity, Integer> mainDao;
    private JdbcConnectionSource mainConnection = Common.connection.getConnection();
    private List<EstimateProduct> lazyProducts = new ArrayList<EstimateProduct>();
    int printId = 0;
//    int layoutId = 0;
    Integer formerId = 0;

    public Estimate(EstimateEntity estimateEntity) {
        this(0);
        this.id = estimateEntity.getId();
        this.number = estimateEntity.getNumber();
        this.issueDate = estimateEntity.getIssueDate();
        this.validUntil = estimateEntity.getValidUntil();
        this.companyDetails = estimateEntity.getCompanyDetails();
        this.client = estimateEntity.getClient();
        this.clientName = estimateEntity.getClientName();
        this.clientCode = estimateEntity.getClientCode();
        this.clientEmail = estimateEntity.getClientEmail();
        this.clientTelephone = estimateEntity.getClientTelephone();
        this.clientContact = estimateEntity.getClientContact();
        this.clientBillingAddress = estimateEntity.getClientBillingAddress();
        this.clientBillingZip = estimateEntity.getClientBillingZip();
        this.clientBillingCity = estimateEntity.getClientBillingCity();
        this.clientShippingAddress = estimateEntity.getClientShippingAddress();
        this.clientShippingZip = estimateEntity.getClientShippingZip();
        this.clientShippingCity = estimateEntity.getClientShippingCity();
        this.isPaid = estimateEntity.isPaid();
        this.isDraft = estimateEntity.isDraft();
        this.totalNoTax = estimateEntity.getTotalNoTax();
        this.totalTax = estimateEntity.getTotalTax();
        this.totalAll = estimateEntity.getTotalAll();
        this.internalNotes = estimateEntity.getInternalNotes();
        this.estimateNotes = estimateEntity.getEstimateNotes();
        this.deleted = estimateEntity.getDeleted();
        this.color = estimateEntity.getColor();
        this.poNumber = estimateEntity.getPoNumber();
        this.pageSize = estimateEntity.getPageSize();
        this.clientBillingState = estimateEntity.getClientBillingState();
        this.clientShippingState = estimateEntity.getClientShippingState();
        this.estimateProducts = estimateEntity.getEstimateProducts();
        this.logo = estimateEntity.getLogo();
        this.flag = estimateEntity.getFlag();
        this.layout = estimateEntity.getLayout();
        this.discount = estimateEntity.getDiscount();
        this.sent = estimateEntity.isSent();
        this.type = estimateEntity.getType();
    }

    public Estimate() {
        this(0);
    }

    public Estimate(Integer id) {
        super();

        if (mainConnection != null) {
            try {
                mainDao = DaoManager.createDao(mainConnection, EstimateEntity.class);

                if (id != null && id != 0) {
                    setId(id);
                    mainDao.refresh(this);
                }

            } catch (Exception e) {
                e.printStackTrace();
            }
        }
    }

    public void refreshDao() {
        try {
            mainDao = DaoManager.createDao(Common.connection.getConnection(), EstimateEntity.class);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void create() throws Exception {
        mainDao.create(this);
    }

    public EstimateEntity read(Integer id) throws Exception {
        return mainDao.queryForId(id);
    }

    public void update() throws Exception {
        mainDao.update(this);
    }

    public void delete() throws Exception {
        mainDao.delete(this);
    }

    @Override
    public void save() throws Exception {
        add(mainConnection, this);
        if (formerId != 0) {
            Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(Common.connection.getConnection(), EstimateEntity.class);
            UpdateBuilder<EstimateEntity, Integer> updateBuilder = estimateDao.updateBuilder();
            updateBuilder.updateColumnValue(Estimate.DELETED, "y");
            updateBuilder.where().eq("id", formerId);
            updateBuilder.update();
        }
    }

    @SuppressWarnings({"rawtypes", "unchecked"})
    public static void add(final JdbcConnectionSource connectionSource, final Estimate estimate) throws SBDaoException, SQLException {

        TransactionManager.callInTransaction(connectionSource, new Callable() {
            @Override
            public Void call() throws Exception {

                Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(connectionSource, EstimateEntity.class);

                estimateDao.create(estimate);
//TODO de utilizat connectionSource.           
//                estimate.create();
                estimate.storeLazyProducts(connectionSource);

                return null;
            }
        });
    }

    public static Date getLastIssueDate(SBConnection connection) {
        Date ret = new Date();
        Dao<EstimateEntity, Integer> estimateDao;
        try {
            estimateDao = DaoManager.createDao(connection.getConnection(), EstimateEntity.class);

            GenericRawResults<String[]> rawResults = estimateDao.queryRaw(
                    "SELECT MAX(issue_date) from estimate where deleted='n'");
            List<String[]> results = rawResults.getResults();
            String date = results.get(0)[0];
            return Common.SQLITE_DATE_FORMAT.parse(date);

        } catch (Exception ex) {
        }

        return ret;
    }

    public static boolean usesPONumber(SBConnection connection) {
        boolean ret = true;
        Dao<EstimateEntity, Integer> estimatesDao;
        try {
            estimatesDao = DaoManager.createDao(connection.getConnection(), EstimateEntity.class);
            GenericRawResults<String> rawResults
                    = estimatesDao.queryRaw(
                            "SELECT po_number from estimate ORDER BY id DESC LIMIT 3",
                            new RawRowMapper<String>() {
                        public String mapRow(String[] columnNames, String[] resultColumns) {
                            return resultColumns[0];
                        }
                    });

            int yes = 0;
            int no = 0;

            List<String> poList = rawResults.getResults();
            for (String po : poList) {
                if (po == null || po.isEmpty()) {
                    no++;
                    continue;
                }
                yes++;
            }

            return yes > no;

        } catch (SQLException ex) {
            ex.printStackTrace();
        }
        return ret;
    }

    public static Estimate get(JdbcConnectionSource connectionSource, Integer id) throws Exception {
        Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(connectionSource, EstimateEntity.class);
        if (id != null) {
            Estimate i = new Estimate();
            i.setId(id);
            if (estimateDao.refresh(i) != 0) {
                return i;
            }
        }
        return null;
    }

    public static Estimate getLast(JdbcConnectionSource connectionSource) throws SBDaoException, SQLException {
        Dao<EstimateEntity, Integer> dao = DaoManager.createDao(Common.connection.getConnection(), EstimateEntity.class);
        PreparedQuery<EstimateEntity> pq = dao.queryBuilder().orderBy("id", false).limit(1L).prepare();
        List<EstimateEntity> list = dao.query(pq);
        if (list.size() > 0) {

            return new Estimate(list.get(0));
        }

        return null;
    }

    public static Estimate get(JdbcConnectionSource connectionSource, String number, String type) throws Exception {
        SelectArg selectArg = new SelectArg();
        Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(connectionSource, EstimateEntity.class);
        PreparedQuery<EstimateEntity> pq = estimateDao.queryBuilder().where().eq(EstimateEntity.NUMBER, selectArg).and()
                .eq(EstimateEntity.DELETED, "n").and().eq(EstimateEntity.TYPE, type).prepare();
        selectArg.setValue(number);
        List<EstimateEntity> list = estimateDao.query(pq);
        if (list != null && list.size() > 0) {
            return new Estimate(list.get(0));
        }
        return null;
    }

    public static boolean hasPriorMismatch(JdbcConnectionSource connectionSource, String number, Date date, String type) throws Exception {
        if (Common.hasLettersOrNonNumbers(number)) {
            return false;
        }
        Dao<EstimateEntity, Integer> estimatesDao = DaoManager.createDao(connectionSource, EstimateEntity.class);
        GenericRawResults<String[]> queryRaw = estimatesDao.queryRaw("SELECT count(*) FROM estimate WHERE CAST(number as integer) > " + number + " AND issue_date < '" + Common.SQLITE_DATE_FORMAT.format(date) + "' AND deleted = 'n'" + " AND type = '" + type + "'");
        List<String[]> results = queryRaw.getResults();
        String[] get = results.get(0);
        return (Integer.parseInt(get[0]) > 0);
    }

    public static boolean hasLaterMismatch(JdbcConnectionSource connectionSource, String number, Date date, String type) throws Exception {
        if (Common.hasLettersOrNonNumbers(number)) {
            return false;
        }
        Dao<EstimateEntity, Integer> estimatesDao = DaoManager.createDao(connectionSource, EstimateEntity.class);
        GenericRawResults<String[]> queryRaw = estimatesDao.queryRaw("SELECT count(*) FROM estimate WHERE CAST(number as integer) < " + number + " AND issue_date > '" + Common.SQLITE_DATE_FORMAT.format(date) + "' AND deleted = 'n'" + " AND type = '" + type + "'");
        List<String[]> results = queryRaw.getResults();
        String[] get = results.get(0);
        return (Integer.parseInt(get[0]) > 0);
    }

    public static long getCount(SBConnection connection) throws SBDaoException, SQLException {
        Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(connection.getConnection(), EstimateEntity.class);
        return estimateDao.countOf();
    }

    public Dao<EstimateEntity, Integer> getMainDao() {
        return mainDao;
    }

    public void setMainDao(Dao<EstimateEntity, Integer> mainDao) {
        this.mainDao = mainDao;
    }

    public List<EstimateProduct> getLazyProducts() {
        return lazyProducts;
    }

    public void setLazyProducts(List<EstimateProduct> lazyProducts) {
        this.lazyProducts = lazyProducts;
    }

    public void addProduct(EstimateProduct product) {
        this.lazyProducts.add(product);
    }

    public void deleteProduct(EstimateProduct product) {
        this.lazyProducts.remove(product);
    }

    public void storeLazyProducts(JdbcConnectionSource connectionSource) throws SQLException {

        Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(connectionSource, EstimateEntity.class);

        estimateDao.assignEmptyForeignCollection(this, "estimateProducts");

//        TransactionManager.callInTransaction(connectionSource, new Callable() {
//            @Override
//            public Void call() throws Exception {
        for (EstimateProduct item : lazyProducts) {

            estimateProducts.add(item);
        }
//                return null;
//            }
//        });

    }

    public static int getLastUsedLayout(JdbcConnectionSource connectionSource) throws Exception {

        Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(connectionSource, EstimateEntity.class);
        PreparedQuery<EstimateEntity> pq = estimateDao.queryBuilder().orderBy("id", false).limit(1L).prepare();
        List<EstimateEntity> list = estimateDao.query(pq);
        if (list.size() > 0) {
            return list.get(0).getLayout();
        }
        return 1;
    }

//	@Override
//	public String getReportTitle() {
//		// TODO Auto-generated method stub
//		return null;
//	}
    @Override
    public String getSerie() {
        // TODO Auto-generated method stub
        return null;
    }

    @Override
    public String getNumber() {
        return number;
    }

    @Override
    public Integer getDocumentPrintId() {
        return printId;
    }

    @Override
    public void setDocumentPrintId(int printId) {
        this.printId = printId;
    }

    @Override
    public String[] getColumnsNames() {
        return columnNames;
    }

    @Override
    public Object[][] getDataForPrint() {
        boolean valueWithTax = false;

        if (getFlag() != null) {
            valueWithTax = getFlag().getValueWithTax();
        }

        NumberFormat nf = NumberFormat.getInstance();
        nf.setMinimumFractionDigits(getFlag() == null ? Common.PRECISION : getFlag().getDecimals());
        nf.setMaximumFractionDigits(getFlag() == null ? Common.PRECISION : getFlag().getDecimals());
        ArrayList<String[]> data = new ArrayList<String[]>();
        int no = 1;

        if (this.estimateProducts != null) {
            for (EstimateProductEntity invEntity : this.estimateProducts) {
                boolean description = invEntity.getDescription() != null && !invEntity.getDescription().isEmpty();
                String descriptionProduct = (description ? (invEntity.getDescription()) : "");
                String total = "";
                String strTax = invEntity.getTax().getTaxName() + " " + invEntity.getTax().getTaxPercentage() + "%";
                String strDiscount = invEntity.getDiscountPercentage().compareTo(BigDecimal.ZERO) == 0 ? "" : "-Discount " + invEntity.getDiscountPercentage() + "%";
                if (valueWithTax) {
                    total = SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalAll()));
                } else {
                    total = SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalNoTax()));
                }
                data.add(new String[]{String.valueOf(no),//no
                    invEntity.getName(),//product
                    descriptionProduct,//description
                    invEntity.getMeasuringUnit(),//um
                    invEntity.getQuantity().toPlainString(),//quantty
                    SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getPrice())),//price
                    strDiscount,//discount
                    SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalNoTax())),//value
                    total, //amount
                    SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalAll().subtract(invEntity.getTotalNoTax()))),//tax amount
                    strTax, //tax name
                    "0"});
                no++;
            }
        } else if (this.lazyProducts != null) {
            for (EstimateProduct invEntity : this.lazyProducts) {
                boolean description = invEntity.getDescription() != null && !invEntity.getDescription().isEmpty();
                String descriptionProduct = (description ? (invEntity.getDescription()) : "");
                String total = "";
                String strTax = invEntity.getTax().getTaxName() + " " + invEntity.getTax().getTaxPercentage() + "%";
                String strDiscount = invEntity.getDiscountPercentage().compareTo(BigDecimal.ZERO) == 0 ? "" : "-" + invEntity.getDiscountPercentage() + "%";
                if (valueWithTax) {
                    total = SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalAll()));
                } else {
                    total = SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalNoTax()));
                }
                data.add(new String[]{String.valueOf(no),//no
                    invEntity.getName(),//product
                    descriptionProduct,//description
                    invEntity.getMeasuringUnit(),//um
                    invEntity.getQuantity().toPlainString(),//quantty
                    SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getPrice())),//price
                    strDiscount,//discount
                    SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalNoTax())),//value
                    total, //amount
                    SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nf.format(invEntity.getTotalAll().subtract(invEntity.getTotalNoTax()))),//tax amount
                    strTax, //tax name
                    "0"});
                no++;
            }
        }
        if (data.size() == 0) {
            data.add(new String[]{"", "", "", "", "", "", "", "", "", "", "", ""});
        }

        return data.toArray(new String[][]{});
    }

    @Override
    public Object[][] getDataForPrintAlb() {
        // TODO Auto-generated method stub
        return null;
    }

//	@Override
//	public DocumentType getTemplate() {
//		// TODO Auto-generated method stub
//		return null;
//	}
//
//	@Override
//	public DocumentType getMainTemplate() {
//		// TODO Auto-generated method stub
//		return null;
//	}
//
//	@Override
//	public DocumentType getAltTemplate() {
//		// TODO Auto-generated method stub
//		return null;
//	}
//    @Override
//    public int getLayoutId() {
//        return layoutId;
//    }
//
//    public void setLayoutId(int layoutId) {
//        this.layoutId = layoutId;
//    }
    @Override
    public Integer getLayout() {
        return super.getLayout();
    }

    @Override
    public void setLayout(Integer layout) {
        super.setLayout(layout);
    }

    @Override
    public Map<String, Object> getJasperParams() {
        boolean totalWithoutDecimals = false;
        boolean totalInWords = false;
        boolean showSignature = false;
        boolean showShipping = false;
        boolean hideAmount = false;
        boolean showUmColumn = false;
        boolean showTaxPercentage = false;
        boolean showPriceColumn = false;
        boolean showQuantityColumn = false;
        boolean showTaxColumn = false;
        boolean showDNAmountColumn = false;

        if (getFlag() != null) {
            totalWithoutDecimals = getFlag().isTotalWithoutDecimals();
            totalInWords = getFlag().isTotalInWords() && !Common.selectedCompanyConfig.get(Config.INDIA).equals("free");
            showSignature = getFlag().isShowSignature();
            showShipping = getFlag().isShowShipping();
            hideAmount = getFlag().isHideAmount();
            showTaxPercentage = getFlag().isShowTaxPercentage();
            showUmColumn = getFlag().isShowUmColumn();
            showQuantityColumn = !getFlag().isReplaceQuantity();
            showPriceColumn = getFlag().isShowUPColumn();
            showTaxColumn = getFlag().isShowTaxColumn();
            showDNAmountColumn = getFlag().isShowDeliveryNoteAmount();
        }

        int generalPrecision = getFlag() == null ? Common.PRECISION : getFlag().getDecimals();
        NumberFormat nfGeneral = NumberFormat.getInstance();
        nfGeneral.setMinimumFractionDigits(generalPrecision);
        nfGeneral.setMaximumFractionDigits(generalPrecision);

        int totalPrecision = totalWithoutDecimals ? 0 : (getFlag() == null ? Common.PRECISION : getFlag().getDecimals());
        NumberFormat nfTotal = NumberFormat.getInstance();
        nfTotal.setMinimumFractionDigits(totalPrecision);
        nfTotal.setMaximumFractionDigits(totalPrecision);

        CompanyDetailsEntity cd = companyDetails;
        Map<String, Object> params = new HashMap<String, Object>();

        //*********************************************************************************************************
//      DETAIL    
        params.put("detail_no", "No");
        params.put("detail_product", flag.getProductLabel());
        params.put("detail_quantity", flag.getQuantityLabel());
        params.put("detail_um", flag.getUmLabel());
        params.put("detail_price", flag.getPriceLabel());
        params.put("detail_tax", flag.getTaxLabel());
        params.put("detail_amount", "Amount");
        params.put("show_ship_to", flag.isShowAddress());
        params.put("show_tax_percentage", showTaxPercentage);
        params.put("show_um_column", showUmColumn);
        params.put("show_price_column", showPriceColumn);
        params.put("show_quantity_column", showQuantityColumn);
        params.put("show_tax_column", showTaxColumn);

        // show delivery note amount column can be setted to false
        // only for Delivery Note document type, otherwise it is true
        if (type.equals(TYPE_DELIVERY)) {
            params.put("show_dn_amount_column", showDNAmountColumn);
        } else {
            params.put("show_dn_amount_column", true);
        }
        
        if (cd.getCurrency() != null) {
            params.put("currency_symbol", cd.getCurrency().getSymbol());
        } else {
            params.put("currency_symbol", "");
        }

//*********************************************************************************************************
//      SUBREPORT TITLE
        if (type.equals(TYPE_QUOTATION)) {
            params.put("title_txt_document", SBStringUtils.capitalizeWords(flag.getEstimateLabel()));
        } else if (type.equals(TYPE_PROFORMA)) {
            params.put("title_txt_document", "Proforma Invoice");
        } else if (type.equals(TYPE_DELIVERY)) {
            params.put("title_txt_document", "Delivery Note");
        }
        if (this.number != null) {
            params.put("title_document_numbrer", this.number);
        } else {
            params.put("title_document_numbrer", "");
        }
        params.put("title_txt_amount_due", "Amount Due");
        if (this.totalAll != null) {
            params.put("title_amount_due", SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nfTotal.format(this.totalAll.setScale(totalPrecision, RoundingMode.HALF_UP))));
        } else {
            params.put("title_amount_due", "");
        }
        params.put("showAmountDue", true);
        if (hideAmount) {
            params.put("title_amount_due", null);
            params.put("showAmountDue", false);
            params.put("title_txt_amount_due", null);
        }

        params.put("title_txt_document_date", "Date");
        if (this.issueDate != null) {
            params.put("title_document_date", Common.jasperDateFormatter.format(this.issueDate));
        } else {
            params.put("title_document_date", "");
        }
        params.put("title_txt_due_date", type.equals(TYPE_DELIVERY) ? "Shipping Date" : "Valid Until");
        if (this.validUntil != null) {
            params.put("title_due_date", Common.jasperDateFormatter.format(this.validUntil));
        } else {
            params.put("title_due_date", "");
        }
        if (this.poNumber != null && !this.poNumber.isEmpty()) {
            try {
                Flag flag = Flag.getLast(Common.connection.getConnection());
                params.put("title_txt_po_number", flag.getPoNumberLabel());
            } catch (Exception ex) {
                Logger.getLogger(JDialogIssueInvoice.class.getName()).log(Level.SEVERE, null, ex);
                params.put("title_txt_po_number", "P.O. Number");
            }
            params.put("title_po_number", this.poNumber);
        } else {
            params.put("title_txt_po_number", "");
            params.put("title_po_number", "");
        }
        if (this.companyDetails != null) {
            String logo = getLogo();
            if (logo != null && logo.equals("smart_edit_mode")) {
                this.logo = "";
            }
            if (getId() <= 0 && (getLogo() == null || getLogo().isEmpty())) {
                logo = (logo != null && logo.equals("smart_edit_mode")) ? "" : this.companyDetails.getLogo();
            }
            this.logo = logo;
            if (logo != null && !logo.isEmpty() && (new File(Common.SAVED_LOGOS_PATH + logo)).isFile()) {
                params.put("title_logo", Common.SAVED_LOGOS_PATH + logo);
            } else {
                params.put("title_logo", "");
            }

            String zip = (this.companyDetails.getZip() == null || this.companyDetails.getZip().isEmpty()) ? "" : ", " + (Common.country.equals("Canada") || Common.country.equals("United Kingdom") ? "Postal Code" : "Zip") + " " + this.companyDetails.getZip();
            String address = "";
            if (this.companyDetails.getAddress() != null && !this.companyDetails.getAddress().isEmpty()) {
                address = this.companyDetails.getAddress();
            }

            params.put("title_provider_company_name", this.companyDetails.getName());
            params.put("title_provider_address", address);
            params.put("title_provider_phone", this.companyDetails.getTelephone()); //"Phone (408) 400-7399 | Fax (408) 400-7399");
            params.put("title_provider_fax", "");
            params.put("title_provider_email", this.companyDetails.getEmail());//
            params.put("title_provider_web", this.companyDetails.getWebsite());//"http://www.slickbill.com/win8/" + "\n" + "http://www.slickbill.com/win8/our-team/");
            StateEntity state = this.companyDetails.getState();
            if (state != null) {
                String s = "";
                if (state.getCity() != null && !state.getCity().isEmpty()) {
                    s = state.getCity();
                }
                if (state.getState() != null && !state.getState().isEmpty()) {
                    s += ", " + state.getState();
                }
                if (s.isEmpty()) {
                    zip = zip.replace(", ", "");
                }
                s += zip;
                if (state.getCountry() != null && !state.getCountry().isEmpty()) {
                    s += ", " + state.getCountry();
                }
                params.put("title_provider_location", s);
            }

            String details = "";
            if (this.companyDetails.getDetails() != null && !this.companyDetails.getDetails().isEmpty()) {
                details = this.companyDetails.getDetails();
            }

            if (this.companyDetails.getTin() != null && !this.companyDetails.getTin().isEmpty()) {
                details += (!details.isEmpty() ? "\nTIN: " : "TIN: ") + companyDetails.getTin();
            }

            if (this.companyDetails.getStn() != null && !this.companyDetails.getStn().isEmpty()) {
                details += (!details.isEmpty() ? "\nService Tax No: " : "Service Tax No: ") + companyDetails.getStn();
            }

            if (this.companyDetails.getPan() != null && !this.companyDetails.getPan().isEmpty()) {
                details += (!details.isEmpty() ? "\nPAN: " : "PAN: ") + companyDetails.getPan();
            }
            params.put("title_provider_additional_details", details);
        } else {
            params.put("title_logo", "");
            params.put("title_provider_company_name", "");
            params.put("title_provider_address", "");
            params.put("title_provider_location", "");
            params.put("title_provider_phone", "");
            params.put("title_provider_fax", "");
            params.put("title_provider_email", "");
            params.put("title_provider_web", "");
        }

        if (this.clientName != null) {
            params.put("title_billing_company_name", this.clientName);//"Company Name");
        } else {
            params.put("title_billing_company_name", "");
        }
        String zipB = (this.clientBillingZip == null || this.clientBillingZip.isEmpty()) ? "" : ", " + (Common.country.equals("Canada") || Common.country.equals("United Kingdom") ? "Postal Code" : "Zip") + " " + this.clientBillingZip;
        if (this.clientBillingAddress != null && !this.clientBillingAddress.isEmpty()) {
            params.put("title_billing_address", this.clientBillingAddress);//"972 Rincon Circle, San Jose, CA 90123");
        } else {
            params.put("title_billing_address", "");
        }
        if (this.clientTelephone != null) {
            params.put("title_billing_phone", this.clientTelephone);//"");
        } else {
            params.put("title_billing_phone", "");
        }
        params.put("title_billing_fax", "");
        params.put("title_billing_web", "");
        params.put("title_billing_location", "");
        if (this.client != null) {
            StateEntity state = this.getClientBillingState();
            if (state != null) {
                String s = "";
                if (state.getCity() != null && !state.getCity().isEmpty()) {
                    s = state.getCity();
                }
                if (state.getState() != null && !state.getState().isEmpty()) {
                    s += ", " + state.getState();
                }
                if (s.isEmpty()) {
                    zipB = zipB.replace(", ", "");
                }
                s += zipB;
                if (state.getCountry() != null && !state.getCountry().isEmpty()) {
                    s += ", " + state.getCountry();
                }
                params.put("title_billing_location", s);
            }

            String clientDetails = "";
            if (this.client.getDetailsPublic() != null && !this.client.getDetailsPublic().isEmpty()) {
                clientDetails += this.client.getDetailsPublic();
            }

            if (this.client.getTin() != null && !this.client.getTin().isEmpty()) {
                clientDetails += (!clientDetails.isEmpty() ? "\nTIN: " : "TIN: ") + this.client.getTin();
            }
            params.put("title_client_additional_details", clientDetails);//"Will appear on your documents");
        }
        if (this.clientName != null) {
            params.put("title_shipping_company_name", this.clientName);//"Company Name");
        } else {
            params.put("title_shipping_company_name", "");
        }
        String zipS = (this.clientShippingZip == null || this.clientShippingZip.isEmpty()) ? "" : ", " + (Common.country.equals("Canada") || Common.country.equals("United Kingdom") ? "Postal Code" : "Zip") + " " + this.clientShippingZip;
        if (this.clientShippingAddress != null && !this.clientShippingAddress.isEmpty()) {
            params.put("title_shipping_address", this.clientShippingAddress);//"972 Rincon del Bonette, San Jose de Mayo, CA 78123");
        } else {
            params.put("title_shipping_address", "");
        }
        if (this.clientTelephone != null) {
            params.put("title_shipping_phone", this.clientTelephone);//"Phone (408) 400-7399 | Fax (408) 400-7399");
        } else {
            params.put("title_shipping_phone", "");
        }
        params.put("title_shipping_fax", "");
        params.put("title_shipping_web", "");
        params.put("title_shipping_location", "");
        if (this.client != null) {
            StateEntity state = this.getClientShippingState();
            if (state != null) {
                String s = "";
                if (state.getCity() != null && !state.getCity().isEmpty()) {
                    s = state.getCity();
                }
                if (state.getState() != null && !state.getState().isEmpty()) {
                    s += ", " + state.getState();
                }
                if (s.isEmpty()) {
                    zipS = zipS.replace(", ", "");
                }
                s += zipS;
                if (state.getCountry() != null && !state.getCountry().isEmpty()) {
                    s += ", " + state.getCountry();
                }
                params.put("title_shipping_location", s);
            }
        }

        String iColor = "./images/icons/" + this.getColorText();
        params.put("icon_address", iColor + "-1.png");
        params.put("icon_web", iColor + "-2.png");
        params.put("icon_phone", iColor + "-4.png");
        params.put("icon_mail", iColor + "-5.png");
        params.put("icon_details", iColor + "-6.png");

//*********************************************************************************************************            
//      SUBREPORT BOTTOM
//		params.put("bottom_notes", "Here is de the Estimate #000178 for November" + "\n" + "Thank you for you business" + "\n" 
//                  + "!! Max 3 lines of notes -........................................................1");
        params.put("bottom_txt_subtotal", "Subtotal");

        //params.put("bottom_string_total_document", "(currency symbol) Nine hundred fifty-six and fourty four paise only");
        params.put("bottom_txt_signature", showSignature ? "Authorized Signatory" : "");
        params.put("pay_link", "");//daca este NULL nu apare textul pe jasper la aviz
        if (this.estimateNotes != null) {
            params.put("bottom_notes", this.estimateNotes);
        } else {
            params.put("bottom_notes", "");
        }
        params.put("bottom_conditions", "");//"Payment conditions 28 days ???");
        params.put("bottom_txt_total_document", "Total " + SBStringUtils.capitalizeWords(flag.getEstimateLabel()));
        if (this.totalNoTax != null) {
            params.put("bottom_subtotal", SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nfGeneral.format(this.totalNoTax.setScale(generalPrecision, RoundingMode.HALF_UP)))); //"100708.10");
        } else {
            params.put("bottom_subtotal", "");
        }
        if (this.totalTax != null) {
            BigDecimal dv = BigDecimal.ZERO;
            BigDecimal dp = BigDecimal.ZERO;
            LinkedHashMap<String, BigDecimal> taxes = new LinkedHashMap<String, BigDecimal>();

            BigDecimal discountAmountTotal = BigDecimal.ZERO;
            BigDecimal discountAmount = BigDecimal.ZERO;
            if (this.estimateProducts != null) {
                for (EstimateProductEntity invEntity : this.estimateProducts) {
                    TaxEntity t = invEntity.getTax();
                    if (t.getId() == Common.noTax.getId()) {
                        continue;
                    }
                    discountAmount = invEntity.getDiscountPercentage().divide(new BigDecimal(100)).multiply(invEntity.getPrice()).multiply(invEntity.getQuantity());
                    discountAmountTotal = discountAmountTotal.add(discountAmount);
                    if (t.getType().equals(Tax.TYPE_COMBINED)) {
                        try {
                            BigDecimal value = invEntity.getTotalNoTax().subtract(dp.divide(new BigDecimal(100)).multiply(invEntity.getTotalNoTax()));
                            BigDecimal taxValue = BigDecimal.ZERO;

                            List<TaxEntity> combined = Tax.getCombined(Common.connection.getConnection(), t.getId());
                            taxValue = value;
                            for (TaxEntity taxEntity : combined) {
                                BigDecimal auxValue = taxValue.subtract(Tax.calculateTax(taxValue, taxEntity.getTaxPercentage()));
                                taxEntity.setTaxValue(taxValue.subtract(auxValue));
                                if (t.isExplicitOrder()) {
                                    taxValue = auxValue;
                                }

                                BigDecimal val = taxes.get(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)");
                                BigDecimal taxToAdd = taxEntity.getTaxValue();
                                if (val == null) {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", taxToAdd);
                                } else {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", val.add(taxToAdd));
                                }
                            }
                        } catch (Exception ex) {
                            ex.printStackTrace();
                        }
                    } else if (t.getType().equals(Tax.TYPE_NORMAL)) {
                        BigDecimal val = taxes.get(t.getTaxName() + " (" + t.getTaxPercentage() + "%)");
                        BigDecimal calculatedTax = Tax.calculateTax(invEntity.getTotalNoTax(), t.getTaxPercentage());
                        BigDecimal taxToAdd = calculatedTax.subtract(dp.divide(new BigDecimal(100)).multiply(calculatedTax));
                        if (val == null) {
                            taxes.put(t.getTaxName() + " (" + t.getTaxPercentage() + "%)", taxToAdd);
                        } else {
                            taxes.put(t.getTaxName() + " (" + t.getTaxPercentage() + "%)", val.add(taxToAdd));
                        }
                    } else {
                        try {
                            BigDecimal value = invEntity.getTotalNoTax().subtract(dp.divide(new BigDecimal(100)).multiply(invEntity.getTotalNoTax()));
                            BigDecimal taxValue = BigDecimal.ZERO;

                            List<TaxEntity> combined = Tax.getMulti(Common.connection.getConnection(), t.getId());
                            taxValue = value.multiply(combined.get(0).getTaxPercentage()).divide(new BigDecimal("100"));
                            combined.get(0).setTaxValue(taxValue);
                            TaxEntity taxEntity = combined.get(0);

                            BigDecimal val = taxes.get(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)");
                            BigDecimal taxToAdd = taxEntity.getTaxValue();
                            if (val == null) {
                                taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", taxToAdd);
                            } else {
                                taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", val.add(taxToAdd));
                            }

                            for (int i = 1; i < combined.size(); i++) {
                                taxEntity = combined.get(i);
                                BigDecimal tv = taxValue.multiply(taxEntity.getTaxPercentage()).divide(new BigDecimal("100"));
                                taxEntity.setTaxValue(tv);
                                taxValue = taxValue.add(tv);

                                val = taxes.get(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)");
                                taxToAdd = taxEntity.getTaxValue();
                                if (val == null) {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", taxToAdd);
                                } else {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", val.add(taxToAdd));
                                }
                            }
                        } catch (Exception ex) {
                            ex.printStackTrace();
                        }
                    }
                }
            } else if (this.lazyProducts != null) {
                for (EstimateProduct invEntity : this.lazyProducts) {
                    TaxEntity t = invEntity.getTax();
                    if (t.getId() == Common.noTax.getId()) {
                        continue;
                    }
                    discountAmount = invEntity.getDiscountPercentage().divide(new BigDecimal(100)).multiply(invEntity.getPrice()).multiply(invEntity.getQuantity());
                    discountAmountTotal = discountAmountTotal.add(discountAmount);
                    if (t.getType().equals(Tax.TYPE_COMBINED)) {
                        try {
                            BigDecimal value = invEntity.getTotalNoTax().subtract(dp.divide(new BigDecimal(100)).multiply(invEntity.getTotalNoTax()));
                            BigDecimal taxValue = BigDecimal.ZERO;

                            List<TaxEntity> combined = Tax.getCombined(Common.connection.getConnection(), t.getId());
                            taxValue = value;
                            for (TaxEntity taxEntity : combined) {
                                BigDecimal auxValue = taxValue.subtract(Tax.calculateTax(taxValue, taxEntity.getTaxPercentage()));
                                taxEntity.setTaxValue(taxValue.subtract(auxValue));
                                if (t.isExplicitOrder()) {
                                    taxValue = auxValue;
                                }

                                BigDecimal val = taxes.get(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)");
                                BigDecimal taxToAdd = taxEntity.getTaxValue();
                                if (val == null) {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", taxToAdd);
                                } else {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", val.add(taxToAdd));
                                }
                            }
                        } catch (Exception ex) {
                            ex.printStackTrace();
                        }
                    } else if (t.getType().equals(Tax.TYPE_NORMAL)) {
                        BigDecimal val = taxes.get(t.getTaxName() + " (" + t.getTaxPercentage() + "%)");
                        BigDecimal calculatedTax = Tax.calculateTax(invEntity.getTotalNoTax(), t.getTaxPercentage());
                        BigDecimal taxToAdd = calculatedTax.subtract(dp.divide(new BigDecimal(100)).multiply(calculatedTax));
                        if (val == null) {
                            taxes.put(t.getTaxName() + " (" + t.getTaxPercentage() + "%)", taxToAdd);
                        } else {
                            taxes.put(t.getTaxName() + " (" + t.getTaxPercentage() + "%)", val.add(taxToAdd));
                        }
                    } else {
                        try {
                            BigDecimal value = invEntity.getTotalNoTax().subtract(dp.divide(new BigDecimal(100)).multiply(invEntity.getTotalNoTax()));
                            BigDecimal taxValue = BigDecimal.ZERO;

                            List<TaxEntity> combined = Tax.getMulti(Common.connection.getConnection(), t.getId());
                            taxValue = value.multiply(combined.get(0).getTaxPercentage()).divide(new BigDecimal("100"));
                            combined.get(0).setTaxValue(taxValue);
                            TaxEntity taxEntity = combined.get(0);

                            BigDecimal val = taxes.get(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)");
                            BigDecimal taxToAdd = taxEntity.getTaxValue();
                            if (val == null) {
                                taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", taxToAdd);
                            } else {
                                taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", val.add(taxToAdd));
                            }

                            for (int i = 1; i < combined.size(); i++) {
                                taxEntity = combined.get(i);
                                BigDecimal tv = taxValue.multiply(taxEntity.getTaxPercentage()).divide(new BigDecimal("100"));
                                taxEntity.setTaxValue(tv);
                                taxValue = taxValue.add(tv);

                                val = taxes.get(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)");
                                taxToAdd = taxEntity.getTaxValue();
                                if (val == null) {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", taxToAdd);
                                } else {
                                    taxes.put(taxEntity.getTaxName() + " (" + taxEntity.getTaxPercentage() + "%)", val.add(taxToAdd));
                                }
                            }
                        } catch (Exception ex) {
                            ex.printStackTrace();
                        }
                    }
                }
            }

            if (discountAmountTotal.compareTo(BigDecimal.ZERO) != 0) {
                taxes.put("Discount", discountAmountTotal.negate().setScale(getFlag().getDecimals(), RoundingMode.HALF_UP));
            }

            try {
                BigDecimal discountValue = this.discount.divide(new BigDecimal(100));
                discountValue = discountValue.multiply(totalTax.add(totalNoTax)).multiply(new BigDecimal(-1));
                taxes.put("Extra Discount" + " (" + discount + "%)", discountValue);
            } catch (Exception e) {
            }

            BigDecimal shippingPrice = BigDecimal.ZERO;
            if (showShipping) {
                shippingPrice = getFlag().getShippingPrice();
                taxes.put(getFlag().getShippingLabel(), getFlag().getShippingPrice());
            }

//        	if(taxes.size() > 1) {
            StringBuffer sbTaxes = new StringBuffer();
            StringBuffer sbValues = new StringBuffer();
            for (String key : taxes.keySet()) {
                if (sbTaxes.length() > 0) {
                    sbTaxes.append("\n");
                }
                sbTaxes.append(key);
                if (sbValues.length() > 0) {
                    sbValues.append("\n");
                }
                sbValues.append(SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nfGeneral.format(taxes.get(key).setScale(generalPrecision, RoundingMode.HALF_UP))));
            }

            if (totalWithoutDecimals) {
                BigDecimal totalRounded = this.totalAll.setScale(totalPrecision, RoundingMode.HALF_UP);
                BigDecimal totalGeneral = this.totalAll.setScale(generalPrecision, RoundingMode.HALF_UP);
                if (sbTaxes.length() > 0) {
                    sbTaxes.append("\n");
                }
                sbTaxes.append("Rounded off");
                if (sbValues.length() > 0) {
                    sbValues.append("\n");
                }
                sbValues.append(SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nfGeneral.format(totalRounded.subtract(totalGeneral).setScale(generalPrecision, BigDecimal.ROUND_HALF_UP))));
            }

            params.put("bottom_txt_total_tax", sbTaxes.toString());
            if (sbTaxes.toString().isEmpty()) {
                params.put("bottom_txt_subtotal", "");
                params.put("bottom_subtotal", "");
            }
            params.put("bottom_tax", sbValues.toString());
//        	} else {
//        		params.put("bottom_txt_total_tax", "TAX");
//        		params.put("bottom_tax", this.totalTax.setScale(precision, RoundingMode.HALF_UP).toPlainString()); //"125.60");
//        	}
        }
        if (this.totalAll != null) {
            params.put("bottom_total_document", SBStringUtils.numberSeparators(getFlag().isIndianFormat(), nfTotal.format(this.totalAll.setScale(totalPrecision, RoundingMode.HALF_UP)))); //"1869773853.50");
            if (totalInWords) {
                String total = this.totalAll.setScale(totalPrecision, RoundingMode.HALF_UP).toPlainString();
                params.put("bottom_string_total_document", SBStringUtils.numberToWordsExtra(getFlag().isIndianFormat(), total, cd, totalWithoutDecimals));
            } else {
                params.put("bottom_string_total_document", "");
            }
        } else {
            params.put("bottom_total_document", "");
            params.put("bottom_string_total_document", "");
        }

        if (getType().equals(TYPE_DELIVERY)) {
            params.put("show_um_column", true);
            params.put("show_quantity_column", true);
            params.put("show_price_column", false);
            params.put("show_tax_column", false);
            params.put("title_amount_due", null);
            params.put("showAmountDue", false);
            params.put("is_challan", true);
            params.put("title_txt_amount_due", null);
        }

        return params;
    }

    @Override
    public String getDocumentTypeName() {
        return DOCUMENT_TYPE_NAME;
    }

    @Override
    public String getSaveFilePath() {
        return Common.selectedCompanyConfig.get(Config.ESTIMATES_SAVE_PATH);
    }

    @Override
    public void setSaveFilePath(String path) {
        Common.selectedCompanyConfig.set(Config.ESTIMATES_SAVE_PATH, path);
    }

    @Override
    public int getClientId() {
        return client.getId();
    }

    @Override
    public String getColorText() {
        return color;
    }

    @Override
    public void setColorText(String color) {
        this.color = color;
    }

    @Override
    public String getPageSizeText() {
        return pageSize.getFormat();
    }

    public Integer getFormerId() {
        return formerId;
    }

    public void setFormerId(Integer formerId) {
        this.formerId = formerId;
    }

    @Override
    public int hashCode() {
        int hash = 7;
        hash = 17 * hash + this.id;
        hash = 17 * hash + (this.number != null ? this.number.hashCode() : 0);
        hash = 17 * hash + (this.issueDate != null ? this.issueDate.hashCode() : 0);
        hash = 17 * hash + (this.validUntil != null ? this.validUntil.hashCode() : 0);
        hash = 17 * hash + (this.companyDetails != null ? this.companyDetails.hashCode() : 0);
        hash = 17 * hash + (this.client != null ? this.client.hashCode() : 0);
        hash = 17 * hash + (this.clientName != null ? this.clientName.hashCode() : 0);
        hash = 17 * hash + (this.clientCode != null ? this.clientCode.hashCode() : 0);
        hash = 17 * hash + (this.clientEmail != null ? this.clientEmail.hashCode() : 0);
        hash = 17 * hash + (this.clientTelephone != null ? this.clientTelephone.hashCode() : 0);
        hash = 17 * hash + (this.clientContact != null ? this.clientContact.hashCode() : 0);
        hash = 17 * hash + (this.clientBillingAddress != null ? this.clientBillingAddress.hashCode() : 0);
        hash = 17 * hash + (this.clientBillingZip != null ? this.clientBillingZip.hashCode() : 0);
        hash = 17 * hash + (this.clientBillingCity != null ? this.clientBillingCity.hashCode() : 0);
        hash = 17 * hash + (this.clientShippingAddress != null ? this.clientShippingAddress.hashCode() : 0);
        hash = 17 * hash + (this.clientShippingZip != null ? this.clientShippingZip.hashCode() : 0);
        hash = 17 * hash + (this.clientShippingCity != null ? this.clientShippingCity.hashCode() : 0);
        hash = 17 * hash + (this.isPaid ? 1 : 0);
        hash = 17 * hash + (this.isDraft ? 1 : 0);
        hash = 17 * hash + (this.totalNoTax != null ? this.totalNoTax.hashCode() : 0);
        hash = 17 * hash + (this.totalTax != null ? this.totalTax.hashCode() : 0);
        hash = 17 * hash + (this.totalAll != null ? this.totalAll.hashCode() : 0);
        hash = 17 * hash + (this.internalNotes != null ? this.internalNotes.hashCode() : 0);
        hash = 17 * hash + (this.estimateNotes != null ? this.estimateNotes.hashCode() : 0);
        hash = 17 * hash + (this.deleted != null ? this.deleted.hashCode() : 0);
        hash = 17 * hash + (this.color != null ? this.color.hashCode() : 0);
        hash = 17 * hash + (this.poNumber != null ? this.poNumber.hashCode() : 0);
        hash = 17 * hash + (this.logo != null ? this.logo.hashCode() : 0);
        hash = 17 * hash + (this.pageSize != null ? this.pageSize.hashCode() : 0);
        hash = 17 * hash + (this.clientBillingState != null ? this.clientBillingState.hashCode() : 0);
        hash = 17 * hash + (this.clientShippingState != null ? this.clientShippingState.hashCode() : 0);
        hash = 17 * hash + (this.flag != null ? this.flag.hashCode() : 0);
        hash = 17 * hash + (this.layout != null ? this.layout.hashCode() : 0);
        hash = 17 * hash + (this.discount != null ? this.discount.hashCode() : 0);
        hash = 17 * hash + (this.sent ? 1 : 0);
        hash = 17 * hash + (this.type != null ? this.type.hashCode() : 0);
        return hash;
    }

    @Override
    public boolean equals(Object obj) {
        if (obj == null) {
            return false;
        }
        if (getClass() != obj.getClass()) {
            return false;
        }
        final Estimate other = (Estimate) obj;
        if (this.id != other.id) {
            return false;
        }
        if ((this.number == null) ? (other.number != null) : !this.number.equals(other.number)) {
            return false;
        }
        if (this.issueDate != other.issueDate && (this.issueDate == null || !this.issueDate.equals(other.issueDate))) {
            return false;
        }
        if (this.validUntil != other.validUntil && (this.validUntil == null || !this.validUntil.equals(other.validUntil))) {
            return false;
        }
        if (this.companyDetails != other.companyDetails && (this.companyDetails == null || !this.companyDetails.equals(other.companyDetails))) {
            return false;
        }
        if (this.client != other.client && (this.client == null || !this.client.equals(other.client))) {
            return false;
        }
        if ((this.clientName == null) ? (other.clientName != null) : !this.clientName.equals(other.clientName)) {
            return false;
        }
        if ((this.clientCode == null) ? (other.clientCode != null) : !this.clientCode.equals(other.clientCode)) {
            return false;
        }
        if ((this.clientEmail == null) ? (other.clientEmail != null) : !this.clientEmail.equals(other.clientEmail)) {
            return false;
        }
        if ((this.clientTelephone == null) ? (other.clientTelephone != null) : !this.clientTelephone.equals(other.clientTelephone)) {
            return false;
        }
        if ((this.clientContact == null) ? (other.clientContact != null) : !this.clientContact.equals(other.clientContact)) {
            return false;
        }
        if ((this.clientBillingAddress == null) ? (other.clientBillingAddress != null) : !this.clientBillingAddress.equals(other.clientBillingAddress)) {
            return false;
        }
        if ((this.clientBillingZip == null) ? (other.clientBillingZip != null) : !this.clientBillingZip.equals(other.clientBillingZip)) {
            return false;
        }
        if ((this.clientBillingCity == null) ? (other.clientBillingCity != null) : !this.clientBillingCity.equals(other.clientBillingCity)) {
            return false;
        }
        if ((this.clientShippingAddress == null) ? (other.clientShippingAddress != null) : !this.clientShippingAddress.equals(other.clientShippingAddress)) {
            return false;
        }
        if ((this.clientShippingZip == null) ? (other.clientShippingZip != null) : !this.clientShippingZip.equals(other.clientShippingZip)) {
            return false;
        }
        if ((this.clientShippingCity == null) ? (other.clientShippingCity != null) : !this.clientShippingCity.equals(other.clientShippingCity)) {
            return false;
        }
        if (this.isPaid != other.isPaid) {
            return false;
        }
        if (this.isDraft != other.isDraft) {
            return false;
        }
        if (this.totalNoTax != other.totalNoTax && (this.totalNoTax == null || !this.totalNoTax.equals(other.totalNoTax))) {
            return false;
        }
        if (this.totalTax != other.totalTax && (this.totalTax == null || !this.totalTax.equals(other.totalTax))) {
            return false;
        }
        if (this.totalAll != other.totalAll && (this.totalAll == null || !this.totalAll.equals(other.totalAll))) {
            return false;
        }
        if ((this.internalNotes == null) ? (other.internalNotes != null) : !this.internalNotes.equals(other.internalNotes)) {
            return false;
        }
        if ((this.estimateNotes == null) ? (other.estimateNotes != null) : !this.estimateNotes.equals(other.estimateNotes)) {
            return false;
        }
        if ((this.deleted == null) ? (other.deleted != null) : !this.deleted.equals(other.deleted)) {
            return false;
        }
        if ((this.color == null) ? (other.color != null) : !this.color.equals(other.color)) {
            return false;
        }
        if ((this.poNumber == null) ? (other.poNumber != null) : !this.poNumber.equals(other.poNumber)) {
            return false;
        }
        if ((this.logo == null) ? (other.logo != null) : !this.logo.equals(other.logo)) {
            return false;
        }
        if (this.pageSize != other.pageSize && (this.pageSize == null || !this.pageSize.equals(other.pageSize))) {
            return false;
        }
        if (this.clientBillingState != other.clientBillingState && (this.clientBillingState == null || !this.clientBillingState.equals(other.clientBillingState))) {
            return false;
        }
        if (this.clientShippingState != other.clientShippingState && (this.clientShippingState == null || !this.clientShippingState.equals(other.clientShippingState))) {
            return false;
        }
        if (this.flag != other.flag && (this.flag == null || !this.flag.equals(other.flag))) {
            return false;
        }
        if (this.layout != other.layout && (this.layout == null || !this.layout.equals(other.layout))) {
            return false;
        }
        if (this.discount != other.discount && (this.discount == null || !this.discount.equals(other.discount))) {
            return false;
        }
        if (this.sent != other.sent) {
            return false;
        }
        if ((this.type == null) ? (other.type != null) : !this.type.equals(other.type)) {
            return false;
        }
        return true;
    }

    @Override
    public String getDocumentLogo() {
        return this.logo;
    }

    @Override
    public void setDocumentLogo(String logo) {
        this.logo = logo;
    }

    @Override
    public boolean isShowResend() {
        return formerId != 0 && sent;
    }
}
