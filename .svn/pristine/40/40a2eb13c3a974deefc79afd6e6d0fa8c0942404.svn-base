/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */
package sleekbill.frames;

import java.awt.Color;
import java.awt.Component;
import java.awt.Font;
import java.awt.GridBagConstraints;
import java.beans.PropertyVetoException;
import java.io.File;
import java.math.BigDecimal;
import java.math.RoundingMode;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import javax.swing.ImageIcon;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.JPanel;
import javax.swing.JTable;
import javax.swing.JTextField;
import javax.swing.JTextPane;
import javax.swing.ToolTipManager;
import javax.swing.event.CellEditorListener;
import javax.swing.event.ChangeEvent;
import javax.swing.table.TableCellEditor;
import javax.swing.table.TableCellRenderer;
import javax.swing.text.Style;
import javax.swing.text.StyleConstants;

import sleekbill.Common;
import sleekbill.Messages;
import sleekbill.beans.Estimate;
import sleekbill.beans.EstimateConversion;
import sleekbill.beans.EstimateProduct;
import sleekbill.entities.EstimateEntity;
import sleekbill.entities.EstimateProductEntity;
import sleekbill.excel.Export;
import sleekbill.excel.NameType;
import sleekbill.frames.autosuggesterdata.SBACClients;
import sleekbill.frames.records.EstimateRecord;
import sleekbill.frames.records.Record;
import sleekbill.jasper.ReportGenerator;
import sleekbill.swingutils.ButtonsEstimates;
import sleekbill.swingutils.CellLabel;
import sleekbill.swingutils.MultiLineCellEditor;
import sleekbill.swingutils.SBDatePicker;
import sleekbill.swingutils.SBJTable;
import sleekbill.swingutils.PaymentCellRenderer;
import sleekbill.util.SBSwingUtils;

import com.j256.ormlite.dao.Dao;
import com.j256.ormlite.dao.DaoManager;
import com.j256.ormlite.stmt.PreparedQuery;
import com.j256.ormlite.stmt.QueryBuilder;
import com.j256.ormlite.stmt.SelectArg;
import com.j256.ormlite.stmt.UpdateBuilder;
import com.j256.ormlite.stmt.Where;
import java.awt.Dimension;
import java.awt.Toolkit;
import java.text.ParseException;
import java.util.TreeSet;
import java.util.logging.Level;
import java.util.logging.Logger;
import javax.swing.JDialog;
import javax.swing.SwingConstants;
import sleekbill.Config;
import sleekbill.beans.Flag;
import sleekbill.beans.Invoice;
import sleekbill.beans.SBDaoException;
import sleekbill.swingutils.YesNoCellRenderer;

/**
 *
 * @author Andrei
 */
public class JDialogEstimatesReport extends JDialogBaseReport {

    SBACClients asData = new SBACClients();
    private static String[] columnNames = {"No.", "Client Name", "Document No.", "Issue Date", "Valid Until", "Amount", "Tax", "Total", "Private Notes", "Emailed", "Type", "Action"};
    private static int[] preferredColumnWidths = {25, 170, 80, 85, 85, 85, 70, 85, 120, 50, 60, 80}; //in functie de vectorul asta se mai fac si alte calcule (cauta "calcul dimensiuni")
    SBDatePicker issueStartDp;
    SBDatePicker issueEndDp;
    //global search fields
    String client;
    String number;
	String type;
    Date issuedStart;
    Date issuedEnd;
	int precision = Common.PRECISION;

    String quick;
	int toolTipDelay = 0;
//    SimpleDateFormat sdf = new SimpleDateFormat("MM-dd-yyyy");
	int columnDiff = 0;
    public JDialogEstimatesReport(java.awt.Frame parent, boolean modal) {
        super(parent, modal);
		
		Dimension dim = Toolkit.getDefaultToolkit().getScreenSize();
		int extra = 0;
		if(dim.width < 1360){
			columnDiff = 1;
			extra = 20;
		}
		
		//calcul dimensiuni (inceput)
		int all = 0;
		for (int i = 0; i < preferredColumnWidths.length; i++) {
			if (i > 1) {
				preferredColumnWidths[i] -= 4;
				all += 4;
			}
		}
		preferredColumnWidths[1] += all-extra;
		//calcul dimensiuni (sfarsit)
		
        initComponents();
        setLocationRelativeTo(parent);
        jPTable = jPTableClients;

        Calendar cal = Calendar.getInstance();
        cal.setTime(Estimate.getLastIssueDate(Common.connection));
        cal.set(Calendar.DATE, 1);
        Date firstDateOfMonth = cal.getTime();
        //cal.add(Calendar.MONTH, 3);
        cal.set(Calendar.DATE, cal.getActualMaximum(Calendar.DATE));
        Date lastDateOfMonth = cal.getTime();

        issueStartDp = new SBDatePicker(firstDateOfMonth);
        issueEndDp = new SBDatePicker(lastDateOfMonth);


        jPIssueStart.add(issueStartDp);
        jPIssueEnd.add(issueEndDp);
        issueStartDp.setHorizontalAlignment(JTextField.CENTER);
        issueEndDp.setHorizontalAlignment(JTextField.CENTER);

        refreshParameters();

        DOCUMENT_TYPE = "QUOTATIONS";
        reportTableModel = new EstimatesReportModel(columnNames, columnNames, preferredColumnWidths);
        reportTable = new EstimatesReportTable(jPTable);

        init(jPTableClients, jPanelNoResults, true);

        GridBagConstraints gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.weighty = 0.1;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        pmPanel.addComponentToControl(jPanelButtons, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.gridwidth = 2;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.CENTER;
        pmPanel.addComponentToControl(jPanelLegend, gridBagConstraints);

        setLocationRelativeTo(parent);

        SBSwingUtils.applyFocusBorder(this);
        SBSwingUtils.addContextMenuToChildren(this);
		
		try {
			precision = Flag.getLast(Common.connection.getConnection()).getDecimals();
		} catch (Exception ex) {
			ex.printStackTrace();
		}
		
    }

    public void actionDelete(int row) {
        Integer id = getRow(pmPanel.getRealRow(row)).getId();
        String client = (String) getRow(pmPanel.getRealRow(row)).data[0];
        try {
            if (Messages.showQuestionMessage(this, "Are you sure you want to delete this quotation?", "Confirmation") == JOptionPane.YES_OPTION) {

                Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(Common.connection.getConnection(), EstimateEntity.class);
                UpdateBuilder<EstimateEntity, Integer> updateBuilder = estimateDao.updateBuilder();
                updateBuilder.updateColumnValue(Estimate.DELETED, "y");
                updateBuilder.where().eq("id", id);
                updateBuilder.update();

                glassPane.showOK("You have successfully deleted the quotation!");
                reportTableModel.refreshDataFire();
            }

        } catch (Exception ex) {
            glassPane.showError("This operation could not be completed!");
        }
    }

    public void actionPreview(int row) {

        if (row >= pmPanel.sPm.getPageSize() || pmPanel.getRealRow(row) >= reportTableModel.getRealSize()) {
            return;
        }

        Estimate lastEstimate = null;
        try {
            lastEstimate = Estimate.getLast(Common.connection.getConnection());
        } catch (Exception ex) {
        }

        Integer id = getRow(pmPanel.getRealRow(row)).getId();
        Estimate e = new Estimate(id);
        e.setDocumentPrintId(Invoice.FORMAT_1INVOICE);
        ReportGenerator r = new ReportGenerator(e);
        r.showDocument();


        Estimate lastEstimate2 = null;
        try {
            lastEstimate2 = Estimate.getLast(Common.connection.getConnection());
        } catch (Exception ex) {
        }

        if (lastEstimate != null && lastEstimate2 != null) {
            if (lastEstimate.getId() != lastEstimate2.getId()) {
                refreshRowFromIndex(lastEstimate2, pmPanel.getRealRow(row));
            }else{
				refreshRowFromIndex(new Estimate(id), pmPanel.getRealRow(row));
			}
        }

    }
    
    public void actionEdit(int row) {

        if (row >= pmPanel.sPm.getPageSize() || pmPanel.getRealRow(row) >= reportTableModel.getRealSize()) {
            return;
        }

        Integer id = getRow(pmPanel.getRealRow(row)).getId();
		Estimate estimate =  new Estimate(id);
		
		final boolean bPaid = !Common.selectedCompanyConfig.get(Config.INDIA).equals("free");
		if (!bPaid && !estimate.getType().equals(Estimate.TYPE_QUOTATION)) {
			if (1 == Messages.showWarningMessage(null, "<html><center>This is a Premium only feature.</center></html>", "Information", new String[]{"Cancel", "Go Premium"}, "Go Premium")) {
				new JDialogRegister(new JDialog(), true, true).setVisible(true);
			}
			return;
		}
		
        JDialogIssueEstimate jd = new JDialogIssueEstimate(this, true, estimate, false);
        jd.setVisible(true);
        
        if (jd.lastSaved != null) {
            refreshRowFromIndex(jd.lastSaved, pmPanel.getRealRow(row));
        }

    }

    public void actionExtra(int row) {

        if (row >= pmPanel.sPm.getPageSize() || pmPanel.getRealRow(row) >= reportTableModel.getRealSize()) {
            return;
        }

        Integer id = getRow(pmPanel.getRealRow(row)).getId();
        try {
            if (EstimateConversion.getByEstimateId(Common.connection.getConnection(), id) != null) {
                if (Messages.showQuestionMessage(this, "You have already converted the selected quotation to an invoice. Do you wish to continue?", "Confirmation") != JOptionPane.YES_OPTION) {
                    return;
                }
            }
        } catch (Exception ex) {
        }

        new JDialogIssueInvoice(this, true, new Estimate(id)).setVisible(true);

    }
    
    public void actionExtra2(int row) {
        if (row >= pmPanel.sPm.getPageSize() || pmPanel.getRealRow(row) >= reportTableModel.getRealSize()) {
            return;
        }

        Integer id = getRow(pmPanel.getRealRow(row)).getId();
		Estimate estimate =  new Estimate(id);
		
		final boolean bPaid = !Common.selectedCompanyConfig.get(Config.INDIA).equals("free");
		if (!bPaid && !estimate.getType().equals(Estimate.TYPE_QUOTATION)) {
			if (1 == Messages.showWarningMessage(null, "<html><center>This is a Premium only feature.</center></html>", "Information", new String[]{"Cancel", "Go Premium"}, "Go Premium")) {
				new JDialogRegister(new JDialog(), true, true).setVisible(true);
			}
			return;
		}
		
        JDialogIssueEstimate jd = new JDialogIssueEstimate(this, true, estimate, true);
        jd.setVisible(true);
        
        if (jd.lastSaved != null) {
            reportTableModel.refreshData();
        }
    }
    
    void refreshRowFromIndex(Estimate estimate, Integer row) {

        BigDecimal totalNoTax = estimate.getTotalNoTax().setScale(precision, RoundingMode.HALF_UP);
        BigDecimal totalTax = estimate.getTotalTax().setScale(precision, RoundingMode.HALF_UP);
        BigDecimal totalAll = estimate.getTotalAll().setScale(precision, RoundingMode.HALF_UP);
//                    EstimateRecord ir = new EstimateRecord(estimate.getId(), estimate.getClientName(), estimate.getNumber(), sdf.format(estimate.getIssueDate()), sdf.format(estimate.getDueDate()), estimate.getTotalNoTax().setScale(precision, RoundingMode.HALF_UP).toString(), estimate.getTotalTax().setScale(precision, RoundingMode.HALF_UP).toString(), estimate.getTotalAll().setScale(precision, RoundingMode.HALF_UP).toString(), estimate.isPaid() ? "1" : "0", estimate.getInternalNotes());
        EstimateRecord ir = new EstimateRecord(estimate.getId(), estimate.getClientName(), estimate.getNumber(),
                estimate.getIssueDate(), estimate.getValidUntil(),
                totalNoTax, totalTax, totalAll, estimate.getInternalNotes(), estimate.isSent(), estimate.getType());

        reportTableModel.updateRow(ir, row);
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {
        java.awt.GridBagConstraints gridBagConstraints;

        jPanelContent = new javax.swing.JPanel();
        jPanelUpper = new javax.swing.JPanel();
        jPanelUpperTitle = new javax.swing.JPanel();
        jLabel4 = new javax.swing.JLabel();
        jPanelSearch = new javax.swing.JPanel();
        jPanelSearchButtons = new javax.swing.JPanel();
        jButtonSearch = new javax.swing.JButton();
        jButtonReset = new javax.swing.JButton();
        jPanelSearchFieldsLeft = new javax.swing.JPanel();
        jLabel1 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jTextFieldEstimateNumber = new javax.swing.JTextField();
        sBACPanelClientName = new sleekbill.swingutils.autosuggesters.SBACPanelTextField(asData, false, false);
        jLabel7 = new javax.swing.JLabel();
        jComboBoxType = new javax.swing.JComboBox();
        jPanelSearchFieldsRight = new javax.swing.JPanel();
        jPIssueEnd = new javax.swing.JPanel();
        jPIssueStart = new javax.swing.JPanel();
        jLabel13 = new javax.swing.JLabel();
        jPanelQuickSearch = new javax.swing.JPanel();
        jTextFieldQuickSearch = new javax.swing.JTextField();
        jLabelHelp1 = new javax.swing.JLabel();
        jLabel15 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jPanelButtons = new javax.swing.JPanel();
        jButtonAddNew = new javax.swing.JButton();
        jButtonExport = new javax.swing.JButton();
        jPanelLowerBorder = new javax.swing.JPanel();
        jPanelResults = new javax.swing.JPanel();
        jPTableClients = new javax.swing.JPanel();
        jPanelLegend = new javax.swing.JPanel();
        jLabelLegend = new javax.swing.JLabel();
        jPanelLowerTitle = new javax.swing.JPanel();
        jLabel6 = new javax.swing.JLabel();
        jLabelTipProduct = new javax.swing.JLabel();
        jPanelNoResults = new sleekbill.swingutils.JPanelNoResults();

        setDefaultCloseOperation(javax.swing.WindowConstants.DISPOSE_ON_CLOSE);
        setTitle("Quotations Report");
        getContentPane().setLayout(new java.awt.GridBagLayout());

        jPanelContent.setBackground(new java.awt.Color(229, 235, 242));
        jPanelContent.setLayout(new java.awt.GridBagLayout());

        jPanelUpper.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(195, 210, 219), 1, true));
        jPanelUpper.setLayout(new java.awt.GridBagLayout());

        jPanelUpperTitle.setBackground(new java.awt.Color(253, 253, 253));
        jPanelUpperTitle.setBorder(javax.swing.BorderFactory.createMatteBorder(1, 1, 0, 1, new java.awt.Color(203, 209, 213)));
        jPanelUpperTitle.setLayout(new java.awt.GridBagLayout());

        jLabel4.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel4.setText("Search Quotations");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelUpperTitle.add(jLabel4, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        jPanelUpper.add(jPanelUpperTitle, gridBagConstraints);

        jPanelSearch.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(203, 209, 213)));
        jPanelSearch.setLayout(new java.awt.GridBagLayout());

        jPanelSearchButtons.setLayout(new java.awt.GridBagLayout());

        jButtonSearch.setIcon(new ImageIcon("./images/buttons/Search.png"));
        jButtonSearch.setText("Search");
        jButtonSearch.setName("bSearch"); // NOI18N
        jButtonSearch.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonSearchActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchButtons.add(jButtonSearch, gridBagConstraints);

        jButtonReset.setIcon(new ImageIcon("./images/buttons/refresh.png"));
        jButtonReset.setText("Reset");
        jButtonReset.setName("bReset"); // NOI18N
        jButtonReset.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonResetActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchButtons.add(jButtonReset, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.gridwidth = 2;
        jPanelSearch.add(jPanelSearchButtons, gridBagConstraints);

        jPanelSearchFieldsLeft.setLayout(new java.awt.GridBagLayout());

        jLabel1.setText("Client Name");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsLeft.add(jLabel1, gridBagConstraints);

        jLabel2.setText("Quotation Number");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsLeft.add(jLabel2, gridBagConstraints);

        jTextFieldEstimateNumber.setMaximumSize(new java.awt.Dimension(160, 20));
        jTextFieldEstimateNumber.setMinimumSize(new java.awt.Dimension(160, 20));
        jTextFieldEstimateNumber.setName("tfInvoiceNumber"); // NOI18N
        jTextFieldEstimateNumber.setPreferredSize(new java.awt.Dimension(160, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsLeft.add(jTextFieldEstimateNumber, gridBagConstraints);

        sBACPanelClientName.setMaximumSize(new java.awt.Dimension(160, 20));
        sBACPanelClientName.setMinimumSize(new java.awt.Dimension(160, 20));
        sBACPanelClientName.setName("tfClientName"); // NOI18N
        sBACPanelClientName.setPreferredSize(new java.awt.Dimension(160, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsLeft.add(sBACPanelClientName, gridBagConstraints);

        jLabel7.setText("Type");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsLeft.add(jLabel7, gridBagConstraints);

        jComboBoxType.setMaximumRowCount(5);
        jComboBoxType.setModel(new javax.swing.DefaultComboBoxModel(new String[] { "All", "Quotation", "Proforma", "Delivery" }));
        jComboBoxType.setBorder(null);
        jComboBoxType.setMinimumSize(new java.awt.Dimension(40, 20));
        jComboBoxType.setName("cbIsPaid"); // NOI18N
        jComboBoxType.setPreferredSize(new java.awt.Dimension(40, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsLeft.add(jComboBoxType, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.weightx = 0.1;
        jPanelSearch.add(jPanelSearchFieldsLeft, gridBagConstraints);

        jPanelSearchFieldsRight.setLayout(new java.awt.GridBagLayout());

        jPIssueEnd.setMinimumSize(new java.awt.Dimension(80, 20));
        jPIssueEnd.setName("tfData"); // NOI18N
        jPIssueEnd.setPreferredSize(new java.awt.Dimension(10, 20));
        jPIssueEnd.setLayout(new javax.swing.BoxLayout(jPIssueEnd, javax.swing.BoxLayout.LINE_AXIS));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 3;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.ipadx = 120;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 10, 5, 5);
        jPanelSearchFieldsRight.add(jPIssueEnd, gridBagConstraints);

        jPIssueStart.setMinimumSize(new java.awt.Dimension(80, 20));
        jPIssueStart.setName("tfData"); // NOI18N
        jPIssueStart.setPreferredSize(new java.awt.Dimension(10, 20));
        jPIssueStart.setLayout(new javax.swing.BoxLayout(jPIssueStart, javax.swing.BoxLayout.LINE_AXIS));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.ipadx = 120;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTHWEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsRight.add(jPIssueStart, gridBagConstraints);

        jLabel13.setText("Issued Between");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsRight.add(jLabel13, gridBagConstraints);

        jPanelQuickSearch.setLayout(new java.awt.GridBagLayout());

        jTextFieldQuickSearch.setMaximumSize(new java.awt.Dimension(200, 20));
        jTextFieldQuickSearch.setMinimumSize(new java.awt.Dimension(200, 20));
        jTextFieldQuickSearch.setName("tfQuickSearch"); // NOI18N
        jTextFieldQuickSearch.setPreferredSize(new java.awt.Dimension(200, 20));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelQuickSearch.add(jTextFieldQuickSearch, gridBagConstraints);

        jLabelHelp1.setIcon(new ImageIcon("./images/buttons/ico_help.png"));
        jLabelHelp1.setToolTipText("Search quotations by product name, notes for client and private notes");
        jLabelHelp1.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jLabelHelp1.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                jLabelHelp1MouseEntered(evt);
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                jLabelHelp1MouseExited(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(5, 2, 5, 5);
        jPanelQuickSearch.add(jLabelHelp1, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.gridwidth = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        jPanelSearchFieldsRight.add(jPanelQuickSearch, gridBagConstraints);

        jLabel15.setText("and");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 2;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(5, 10, 5, 10);
        jPanelSearchFieldsRight.add(jLabel15, gridBagConstraints);

        jLabel3.setText("Quick Search");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelSearchFieldsRight.add(jLabel3, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        gridBagConstraints.weightx = 0.1;
        jPanelSearch.add(jPanelSearchFieldsRight, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTH;
        gridBagConstraints.weightx = 0.1;
        jPanelUpper.add(jPanelSearch, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.NORTH;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(15, 15, 15, 15);
        jPanelContent.add(jPanelUpper, gridBagConstraints);

        jPanelButtons.setLayout(new java.awt.GridBagLayout());

        jButtonAddNew.setFont(new java.awt.Font("Tahoma", 1, 11)); // NOI18N
        jButtonAddNew.setForeground(new java.awt.Color(35, 130, 165));
        jButtonAddNew.setIcon(new ImageIcon("./images/buttons/Page.png"));
        jButtonAddNew.setText("New Quotation");
        jButtonAddNew.setName("bNewInvoice"); // NOI18N
        jButtonAddNew.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonAddNewActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 0, 5);
        jPanelButtons.add(jButtonAddNew, gridBagConstraints);

        jButtonExport.setIcon(new ImageIcon("./images/buttons/Page_export.png"));
        jButtonExport.setText("Export");
        jButtonExport.setName("bExport"); // NOI18N
        jButtonExport.addActionListener(new java.awt.event.ActionListener() {
            public void actionPerformed(java.awt.event.ActionEvent evt) {
                jButtonExportActionPerformed(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 2;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.insets = new java.awt.Insets(0, 5, 0, 5);
        jPanelButtons.add(jButtonExport, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 4;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        gridBagConstraints.weightx = 0.1;
        jPanelContent.add(jPanelButtons, gridBagConstraints);

        jPanelLowerBorder.setBorder(new javax.swing.border.LineBorder(new java.awt.Color(195, 210, 219), 1, true));
        jPanelLowerBorder.setLayout(new java.awt.GridBagLayout());

        jPanelResults.setBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(203, 209, 213)));
        jPanelResults.setLayout(new java.awt.GridBagLayout());

        jPTableClients.setName("tableInvoices"); // NOI18N
        jPTableClients.setLayout(new javax.swing.BoxLayout(jPTableClients, javax.swing.BoxLayout.LINE_AXIS));
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.weighty = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelResults.add(jPTableClients, gridBagConstraints);

        jPanelLegend.setForeground(new java.awt.Color(255, 0, 0));
        jPanelLegend.setLayout(new java.awt.GridBagLayout());

        jLabelLegend.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabelLegend.setForeground(new java.awt.Color(255, 0, 0));
        jLabelLegend.setText("*Quotations in red have expired or will expire today.");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        jPanelLegend.add(jLabelLegend, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        jPanelResults.add(jPanelLegend, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 3;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.weighty = 0.1;
        jPanelLowerBorder.add(jPanelResults, gridBagConstraints);

        jPanelLowerTitle.setBackground(new java.awt.Color(253, 253, 253));
        jPanelLowerTitle.setBorder(javax.swing.BorderFactory.createMatteBorder(1, 1, 0, 1, new java.awt.Color(203, 209, 213)));
        jPanelLowerTitle.setLayout(new java.awt.GridBagLayout());

        jLabel6.setFont(new java.awt.Font("Tahoma", 0, 12)); // NOI18N
        jLabel6.setText("Results");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelLowerTitle.add(jLabel6, gridBagConstraints);

        jLabelTipProduct.setIcon(new ImageIcon("./images/buttons/ico_help.png"));
        jLabelTipProduct.setToolTipText("<html>\nYou can customize the labels to appear on the printed documents in <b>Settings > Document Preferences</b>.<br>e.g. if you use <b>Services</b> rather than <b>Products</b>, etc\n</html>");
        jLabelTipProduct.setCursor(new java.awt.Cursor(java.awt.Cursor.HAND_CURSOR));
        jLabelTipProduct.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseExited(java.awt.event.MouseEvent evt) {
                jLabelTipProductMouseExited(evt);
            }
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                jLabelTipProductMouseEntered(evt);
            }
        });
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 1;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.EAST;
        gridBagConstraints.insets = new java.awt.Insets(5, 5, 5, 5);
        jPanelLowerTitle.add(jLabelTipProduct, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 2;
        gridBagConstraints.fill = java.awt.GridBagConstraints.HORIZONTAL;
        jPanelLowerBorder.add(jPanelLowerTitle, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 1;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.weighty = 0.1;
        gridBagConstraints.insets = new java.awt.Insets(0, 15, 15, 15);
        jPanelContent.add(jPanelLowerBorder, gridBagConstraints);

        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        gridBagConstraints.anchor = java.awt.GridBagConstraints.WEST;
        gridBagConstraints.weightx = 0.1;
        gridBagConstraints.weighty = 0.1;
        getContentPane().add(jPanelContent, gridBagConstraints);

        jPanelNoResults.setLabel("There are no results for your search criteria...");
        gridBagConstraints = new java.awt.GridBagConstraints();
        gridBagConstraints.gridx = 0;
        gridBagConstraints.gridy = 0;
        gridBagConstraints.fill = java.awt.GridBagConstraints.BOTH;
        getContentPane().add(jPanelNoResults, gridBagConstraints);

        pack();
    }// </editor-fold>//GEN-END:initComponents

    private void jButtonAddNewActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonAddNewActionPerformed

        JDialogIssueEstimate jDialogIssueEstimate = new JDialogIssueEstimate(this, true);
        jDialogIssueEstimate.setVisible(true);
        refreshParameters();
        reportTableModel.refreshData();
    }//GEN-LAST:event_jButtonAddNewActionPerformed

    private void jButtonSearchActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonSearchActionPerformed
        refreshParameters();
        reportTableModel.refreshData();
    }//GEN-LAST:event_jButtonSearchActionPerformed

    private void jButtonResetActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonResetActionPerformed
        try {
            Calendar cal = Calendar.getInstance();
            cal.setTime(Estimate.getLastIssueDate(Common.connection));
            cal.set(Calendar.DATE, 1);
            Date firstDateOfMonth = cal.getTime();
            //cal.add(Calendar.MONTH, 3);
            cal.set(Calendar.DATE, cal.getActualMaximum(Calendar.DATE));
            Date lastDateOfMonth = cal.getTime();

            issueStartDp.setDate(firstDateOfMonth);
            issueEndDp.setDate(lastDateOfMonth);
        } catch (PropertyVetoException ex) {
            ex.printStackTrace();
        }

        jTextFieldQuickSearch.setText("");
        jTextFieldEstimateNumber.setText("");
        sBACPanelClientName.getSbTextField().setText("");
		jComboBoxType.setSelectedIndex(0);
    }//GEN-LAST:event_jButtonResetActionPerformed

    private void jButtonExportActionPerformed(java.awt.event.ActionEvent evt) {//GEN-FIRST:event_jButtonExportActionPerformed

        String filename = "Quotations.xls";

        File file = new File(filename);
        JFileChooser efc = new JFileChooser();
        efc.setSelectedFile(file);
        if (efc.showSaveDialog(this) == JFileChooser.APPROVE_OPTION) {
            file = efc.getSelectedFile();
            if (file.exists()) {
                if (Messages.showQuestionMessage(this, "The file already exists. Would you like to overwrite?", "Save file") != JOptionPane.YES_OPTION) {
                    return;
                }
            }
            try {
                ArrayList<Integer> idList = new ArrayList<Integer>();
                for(int i = 0; i< reportTableModel.getData().size(); i++){
                    idList.add(reportTableModel.getRow(i).getId());
                }
				String interval = Common.companyDetails.getName() + ": " + (issueStartDp.getDate() == null ? "*" : Common.US_DATE_FORMAT.format(issueStartDp.getDate())) + " - " + (issueEndDp.getDate() == null ? "*" : Common.US_DATE_FORMAT.format(issueEndDp.getDate()));
                Export.DownloadEstimates(file, NameType.ESTIMATE_COLUMNS, idList, interval);
                glassPane.showOK("Export complete!");
            } catch (Exception e) {
                glassPane.showError("This operation could not be completed. If the file already exists, please check that it is closed.");
            }
        }
    }//GEN-LAST:event_jButtonExportActionPerformed

    private void jLabelHelp1MouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jLabelHelp1MouseEntered
        toolTipDelay = ToolTipManager.sharedInstance().getInitialDelay() > 0 ? ToolTipManager.sharedInstance().getInitialDelay() : toolTipDelay;
        ToolTipManager.sharedInstance().setInitialDelay(0);
    }//GEN-LAST:event_jLabelHelp1MouseEntered

    private void jLabelHelp1MouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jLabelHelp1MouseExited
        if (toolTipDelay > 0) {
            ToolTipManager.sharedInstance().setInitialDelay(toolTipDelay);
        }
    }//GEN-LAST:event_jLabelHelp1MouseExited

    private void jLabelTipProductMouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jLabelTipProductMouseEntered
        toolTipDelay = ToolTipManager.sharedInstance().getInitialDelay() > 0 ? ToolTipManager.sharedInstance().getInitialDelay() : toolTipDelay;
        ToolTipManager.sharedInstance().setInitialDelay(0);
    }//GEN-LAST:event_jLabelTipProductMouseEntered

    private void jLabelTipProductMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_jLabelTipProductMouseExited
        if (toolTipDelay > 0) {
            ToolTipManager.sharedInstance().setInitialDelay(toolTipDelay);
        }
    }//GEN-LAST:event_jLabelTipProductMouseExited

    private void setQuickMode(boolean bQuick) {
        sBACPanelClientName.getSbTextField().setEditable(bQuick);
        sBACPanelClientName.getButton().setEnabled(bQuick);
        jTextFieldEstimateNumber.setEditable(bQuick);
        issueStartDp.setEnabled(bQuick);
        issueEndDp.setEnabled(bQuick);
        jTextFieldQuickSearch.setEditable(!bQuick);
    }

    private void refreshParameters() {

        jLabelLegend.setVisible(false);
        client = sBACPanelClientName.getSbTextField().getText();
        number = jTextFieldEstimateNumber.getText();
        issuedStart = issueStartDp.getDate() == null ? new Date(0) : issueStartDp.getDate();
        issuedEnd = issueEndDp.getDate() == null ? new Date(Long.MAX_VALUE) : issueEndDp.getDate();
        quick = jTextFieldQuickSearch.getText();
		
		switch (jComboBoxType.getSelectedIndex()) {
			case 1:
				type = Estimate.TYPE_QUOTATION;
				break;
			case 2:
				type = Estimate.TYPE_PROFORMA;
				break;
			case 3:
			type = Estimate.TYPE_DELIVERY;
			break;
			default:
				type = "%";
				break;
		}

        client = "%" + client + "%";
        number = "%" + number + "%";
        quick = "%" + quick + "%";

    }

    public class EstimatesReportModel extends ReportTableModel {

        public EstimatesReportModel(String[] columnNames, String[] columns, int[] preferredColumnWidths) {
            super(columnNames, columns, preferredColumnWidths, null, null);
        }

        @Override
        public ArrayList<Record> getData() {

            ArrayList<Record> results = new ArrayList<Record>();
            try {
                Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(
                        Common.connection.getConnection(), EstimateEntity.class);

                SelectArg selectClient = new SelectArg();
                SelectArg selectNumber = new SelectArg();
                Where<EstimateEntity, Integer> condition = estimateDao.queryBuilder().orderByRaw(" issue_date DESC, CAST(number as integer) DESC ").where()
                        .like(Estimate.CLIENT_NAME, selectClient)
                        .and().like(Estimate.NUMBER, selectNumber)
                        .and().between(Estimate.ISSUE_DATE, issuedStart, issuedEnd)
                        .and().eq(Estimate.DELETED, "n")
						.and().like(Estimate.TYPE, type);

                PreparedQuery<EstimateEntity> prepare = condition.prepare();
                selectClient.setValue(client);
                selectNumber.setValue(number);
                

                if (quick != null && !quick.equals("%%")) {

                    SelectArg selectQuick1 = new SelectArg();
                    SelectArg selectQuick2 = new SelectArg();
                    SelectArg selectQuick3 = new SelectArg();
                    Dao<EstimateProductEntity, Integer> estimateProductDao = DaoManager.createDao(
                            Common.connection.getConnection(), EstimateProductEntity.class);

                    QueryBuilder<EstimateProductEntity, Integer> queryBuilder = estimateProductDao.queryBuilder();
                    queryBuilder = queryBuilder.selectColumns("estimate_id");
                    queryBuilder.setWhere(estimateProductDao.queryBuilder().where().like(EstimateProduct.NAME, selectQuick1));

                    condition = estimateDao.queryBuilder().where()
                            .like(Estimate.INTERNAL_NOTES, selectQuick2)
                            .or().like(Estimate.ESTIMATE_NOTES, selectQuick3)
                            .or().in("id", queryBuilder)
                            .and().eq(Estimate.DELETED, "n");
                    selectQuick1.setValue(quick);
                    selectQuick2.setValue(quick);
                    selectQuick3.setValue(quick);
                    prepare = condition.prepare();
                }

                List<EstimateEntity> query = estimateDao.query(prepare);

                for (EstimateEntity estimate : query) {
                    BigDecimal totalNoTax = estimate.getTotalNoTax().setScale(precision, RoundingMode.HALF_UP);
                    BigDecimal totalTax = estimate.getTotalTax().setScale(precision, RoundingMode.HALF_UP);
                    BigDecimal totalAll = estimate.getTotalAll().setScale(precision, RoundingMode.HALF_UP);
//                    EstimateRecord ir = new EstimateRecord(estimate.getId(), estimate.getClientName(), estimate.getNumber(), sdf.format(estimate.getIssueDate()), sdf.format(estimate.getDueDate()), estimate.getTotalNoTax().setScale(precision, RoundingMode.HALF_UP).toString(), estimate.getTotalTax().setScale(precision, RoundingMode.HALF_UP).toString(), estimate.getTotalAll().setScale(precision, RoundingMode.HALF_UP).toString(), estimate.isPaid() ? "1" : "0", estimate.getInternalNotes());
					EstimateRecord ir = new EstimateRecord(estimate.getId(), estimate.getClientName(), estimate.getNumber(),
							estimate.getIssueDate(), estimate.getValidUntil(), 
							totalNoTax, totalTax, totalAll, estimate.getInternalNotes(), estimate.isSent(), estimate.getType());
//                    try {
//                        if (sdf.parse(sdf.format(estimate.getDueDate())).before(new Date()) && !estimate.isPaid()) {
                    	if (estimate.getValidUntil().compareTo(new Date()) <= 0) {
                            jLabelLegend.setVisible(true);
                        }
//                    } catch (ParseException ex) {
//                        ex.printStackTrace();
//                    }
                    results.add(ir);

                }
				
				Dimension dim = Toolkit.getDefaultToolkit().getScreenSize();
				if (dim.width < 1360) {
					alwaysHideColumns = new TreeSet<Integer>();
					alwaysHideColumns.add(10);
				}

            hiddenColumns.addAll(alwaysHideColumns);
            } catch (SQLException ex) {
                ex.printStackTrace();
            }

            hiddenColumns.addAll(alwaysHideColumns);
            fireTableStructureChanged();

            if (pmPanel != null) {
                pmPanel.hardreset();
            }

            if (reportTable != null && reportTable.getColumnCount() > 0) {
                new ButtonsEstimates(reportTable, reportTable.getColumnCount() - 1);
            }

            if (reportTable != null) {
                for (int i = 0; i < reportTable.getColumnCount() - 1; i++) {
                    reportTable.getColumnModel().getColumn(i).setHeaderRenderer(sortButtonRenderer);
                }
                reportTable.setPreferredColumnWidths();
            }

            return results;
        }

        @Override
        public boolean isCellEditable(int row, int col) {
             if (col == Arrays.asList(columnNames).indexOf("Action")-columnDiff || col == Arrays.asList(columnNames).indexOf("Private Notes")) {
                return true;
            } else {
                return false;
            }
        }
    }

    public class EstimatesReportTable extends ReportTable {

        public EstimatesReportTable(JPanel p) {
            super(p);
        }

        @Override
        public TableCellEditor getCellEditor(int row, int column) {

            int diff = pmPanel.sPm.getRealRowCount() <= pmPanel.sPm.pageSize ? 2 : 3;
            if (row >= getRowCount() - diff) {
                return null;
            }

            ColoredBasicMultiLineCellEditor mle = new ColoredBasicMultiLineCellEditor(reportTable);
            mle.addCellEditorListener(new CellEditorListener() {
                @Override
                public void editingStopped(ChangeEvent e) {
                    try {
                        MultiLineCellEditor mle = (MultiLineCellEditor) e.getSource();
                        int id = ((EstimatesReportModel) reportTableModel).getId(pmPanel.getRealRow(mle.getRow()));

                        SelectArg selectNote = new SelectArg();
                        Dao<EstimateEntity, Integer> estimateDao = DaoManager.createDao(Common.connection.getConnection(), EstimateEntity.class);
                        UpdateBuilder<EstimateEntity, Integer> updateBuilder = estimateDao.updateBuilder();
                        updateBuilder.updateColumnValue(Estimate.INTERNAL_NOTES, selectNote);
                        updateBuilder.where().eq("id", id);
                        selectNote.setValue(mle.getCellEditorValue().toString());
                        updateBuilder.update();

                        reportTableModel.getRow(pmPanel.getRealRow(mle.getRow())).data[7] = mle.getCellEditorValue().toString();
                        reportTableModel.fireTableRowsUpdated(pmPanel.getRealRow(mle.getRow()), pmPanel.getRealRow(mle.getRow()));

                    } catch (SQLException ex) {
                        ex.printStackTrace();
                    }
                }

                @Override
                public void editingCanceled(ChangeEvent e) {
                    return;
                }
            });
            if (column == Arrays.asList(columnNames).indexOf("Private Notes")) {
                return mle;
            }

            return super.getCellEditor(row, column);
        }

        @Override
        public TableCellRenderer getCellRenderer(int row, int column) {
            
            int diff = pmPanel.sPm.getRowCount() == pmPanel.sPm.pageSize ? 2 : 3;
            if (pmPanel.sPm.getRowCount() >= pmPanel.sPm.pageSize) {
                diff = 2;
            }
            if (pmPanel.sPm.getPageCount() == 1 && pmPanel.sPm.getRowCount() <= pmPanel.sPm.pageSize) {
                diff = 2;
            }
            if (pmPanel.sPm.getPageCount() > 1 && pmPanel.sPm.getPageOffset() == pmPanel.sPm.getPageCount() - 1) {
                diff = 3;
            }
            if (row >= getRowCount() - diff - (pmPanel.sPm.getPageOffset() != pmPanel.sPm.getPageCount() - 1 ? 1 : 0)) {

                return new BoldCellLabel();
            }
			
			if (Arrays.asList(columnNames).indexOf("Emailed") == column && !getValueAt(row, column).equals("")) {
                boolean sent = pmPanel.sPm.getValueAt(row, column).toString().equals("1");
                return new YesNoCellRenderer(sent);
            }

            if (Arrays.asList(columnNames).indexOf("Private Notes") == column) {
                return new ColoredBasicMultiLineCellRenderer(reportTable);
            }

            if (column != Arrays.asList(columnNames).indexOf("Action")-columnDiff && row < getRowCount() - diff) {
                return new ColoredCellLabel();
            }

            return super.getCellRenderer(row, column);
        }

        public class ColoredCellLabel extends CellLabel {

            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int r, int c) {
                CellLabel cl = (CellLabel) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, r, c);
                Object row = pmPanel.sPm.getValueAt(r, 4);
                Date d = (row == null || row.toString().isEmpty()) ? new Date() : (Date) row;
                if (d.compareTo(new Date()) <= 0) {
                    cl.setForeground(Color.RED);
                }
                
                if(c==1){
                    setHorizontalAlignment(SwingConstants.LEFT);
                }

                return cl;
            }
        }

        public class BoldCellLabel extends CellLabel {

            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int r, int c) {
                CellLabel cl = (CellLabel) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, r, c);
                cl.setFont(new Font(cl.getFont().getName(), Font.BOLD, cl.getFont().getSize() + 1));

                return cl;
            }
        }

        public class ColoredBasicMultiLineCellRenderer extends BasicMultiLineCellRenderer {

            public ColoredBasicMultiLineCellRenderer(SBJTable t) {
                super(t);

            }

            @Override
            public Component getTableCellRendererComponent(JTable table, Object value, boolean isSelected, boolean hasFocus, int r, int c) {
                JTextPane mcr = (JTextPane) super.getTableCellRendererComponent(table, value, isSelected, hasFocus, r, c);
                Object row = pmPanel.sPm.getValueAt(r, 4);
                Date d = (row == null || row.toString().isEmpty()) ? new Date() : (Date)row;
                if (d.compareTo(new Date()) <= 0) {
                    Style style = mcr.getStyle("selected");
                    StyleConstants.setForeground(style, Color.RED);
                    mcr.getStyledDocument().setParagraphAttributes(0, 0, style, true);
                }

                return mcr;
            }
        }

        public class ColoredBasicMultiLineCellEditor extends MultiLineCellEditor {

            public ColoredBasicMultiLineCellEditor(SBJTable t) {
                super(t);
            }

            @Override
            public Component getTableCellEditorComponent(JTable table, Object value, boolean isSelected, int row, int column) {
                JTextPane ed = (JTextPane) super.getTableCellEditorComponent(table, value, isSelected, row, column);
                Object rowData = pmPanel.sPm.getValueAt(row, 4);
                Date d = (rowData == null || rowData.toString().isEmpty()) ? new Date() : (Date) rowData;
                if (d.compareTo(new Date()) <= 0) {
                    Style style = ed.getStyle("selected");
                    StyleConstants.setForeground(style, Color.RED);
                    ed.getStyledDocument().setParagraphAttributes(0, 0, style, true);
                }

                return ed;
            }
        }
    }

    /**
     * @param args the command line arguments
     */
    public static void main(String args[]) {
        /* Set the Nimbus look and feel */
        //<editor-fold defaultstate="collapsed" desc=" Look and feel setting code (optional) ">
        /* If Nimbus (introduced in Java SE 6) is not available, stay with the default look and feel.
         * For details see http://download.oracle.com/javase/tutorial/uiswing/lookandfeel/plaf.html 
         */
        try {
            for (javax.swing.UIManager.LookAndFeelInfo info : javax.swing.UIManager.getInstalledLookAndFeels()) {
                if ("Nimbus".equals(info.getName())) {
                    javax.swing.UIManager.setLookAndFeel(info.getClassName());
                    break;
                }
            }
        } catch (ClassNotFoundException ex) {
            java.util.logging.Logger.getLogger(JDialogClientsReport.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (InstantiationException ex) {
            java.util.logging.Logger.getLogger(JDialogClientsReport.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (IllegalAccessException ex) {
            java.util.logging.Logger.getLogger(JDialogClientsReport.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        } catch (javax.swing.UnsupportedLookAndFeelException ex) {
            java.util.logging.Logger.getLogger(JDialogClientsReport.class.getName()).log(java.util.logging.Level.SEVERE, null, ex);
        }
        //</editor-fold>

        /* Create and display the dialog */
        java.awt.EventQueue.invokeLater(new Runnable() {
            public void run() {
                JDialogEstimatesReport dialog = new JDialogEstimatesReport(new javax.swing.JFrame(), true);
                dialog.addWindowListener(new java.awt.event.WindowAdapter() {
                    @Override
                    public void windowClosing(java.awt.event.WindowEvent e) {
                        System.exit(0);
                    }
                });
                dialog.setVisible(true);
            }
        });
    }
    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JButton jButtonAddNew;
    private javax.swing.JButton jButtonExport;
    private javax.swing.JButton jButtonReset;
    private javax.swing.JButton jButtonSearch;
    private javax.swing.JComboBox jComboBoxType;
    private javax.swing.JLabel jLabel1;
    private javax.swing.JLabel jLabel13;
    private javax.swing.JLabel jLabel15;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel6;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabelHelp1;
    private javax.swing.JLabel jLabelLegend;
    private javax.swing.JLabel jLabelTipProduct;
    private javax.swing.JPanel jPIssueEnd;
    private javax.swing.JPanel jPIssueStart;
    private javax.swing.JPanel jPTableClients;
    private javax.swing.JPanel jPanelButtons;
    private javax.swing.JPanel jPanelContent;
    private javax.swing.JPanel jPanelLegend;
    private javax.swing.JPanel jPanelLowerBorder;
    private javax.swing.JPanel jPanelLowerTitle;
    private sleekbill.swingutils.JPanelNoResults jPanelNoResults;
    private javax.swing.JPanel jPanelQuickSearch;
    private javax.swing.JPanel jPanelResults;
    private javax.swing.JPanel jPanelSearch;
    private javax.swing.JPanel jPanelSearchButtons;
    private javax.swing.JPanel jPanelSearchFieldsLeft;
    private javax.swing.JPanel jPanelSearchFieldsRight;
    private javax.swing.JPanel jPanelUpper;
    private javax.swing.JPanel jPanelUpperTitle;
    private javax.swing.JTextField jTextFieldEstimateNumber;
    private javax.swing.JTextField jTextFieldQuickSearch;
    private sleekbill.swingutils.autosuggesters.SBACPanelTextField sBACPanelClientName;
    // End of variables declaration//GEN-END:variables
}
